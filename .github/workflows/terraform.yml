name: Terraform - Entra ID Group

on:
  push:
    branches: [ "Dev" ]
  workflow_dispatch:

permissions:
  id-token: write   # REQUIRED for OIDC
  contents: read

env:
  # Required by Terraform Azure providers & backend when using OIDC
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}       # set in Repo or Org Variables
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}       # the App Registration (SP) clientId
  AZURE_SUBSCRIPTION_ID: ${{ vars.ARM_SUBSCRIPTION_ID }} # needed for azurerm backend
  AZURE_USE_OIDC: true

jobs:
  plan-apply:
    runs-on: ubuntu-latest
    environment: Dev   # must match your Federated Credential subject if you used environment

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: terraform plan -no-color -input=false -var-file="terraform.tfvars"

      # Optional: protect apply with env approvals in GitHub
      - name: Terraform Apply
        if: github.ref == 'refs/heads/dev'
        run: terraform apply -auto-approve -input=false -var-file="terraform.tfvars"
